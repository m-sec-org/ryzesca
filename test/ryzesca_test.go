package test

import (
	"RyzeSCA/grpc/server/ryzesca"
	"context"
	"fmt"
	"google.golang.org/grpc"
	"testing"
)

func TestThemisServer_RunThemisCycloneDX(t *testing.T) {
	py_sbom := "{\n  \"$schema\":\"http://cyclonedx.org/schema/bom-1.4.schema.json\",\n  \"bomFormat\":\"CycloneDX\",\n  \"components\":[\n    {\n      \"bom-ref\":\"pkg:pypi/setuptools@18.1\",\n      \"name\":\"setuptools\",\n      \"purl\":\"pkg:pypi/setuptools@18.1\",\n      \"type\":\"library\",\n      \"version\":\"18.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/celery@3.1.19\",\n      \"name\":\"celery\",\n      \"purl\":\"pkg:pypi/celery@3.1.19\",\n      \"type\":\"library\",\n      \"version\":\"3.1.19\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/kombu@3.0.37\",\n      \"name\":\"kombu\",\n      \"purl\":\"pkg:pypi/kombu@3.0.37\",\n      \"type\":\"library\",\n      \"version\":\"3.0.37\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/billiard@3.3.0.23\",\n      \"name\":\"billiard\",\n      \"purl\":\"pkg:pypi/billiard@3.3.0.23\",\n      \"type\":\"library\",\n      \"version\":\"3.3.0.23\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/pytz@2019.1\",\n      \"name\":\"pytz\",\n      \"purl\":\"pkg:pypi/pytz@2019.1\",\n      \"type\":\"library\",\n      \"version\":\"2019.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/amqp@1.4.9\",\n      \"name\":\"amqp\",\n      \"purl\":\"pkg:pypi/amqp@1.4.9\",\n      \"type\":\"library\",\n      \"version\":\"1.4.9\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/anyjson@0.3.3\",\n      \"name\":\"anyjson\",\n      \"purl\":\"pkg:pypi/anyjson@0.3.3\",\n      \"type\":\"library\",\n      \"version\":\"0.3.3\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/celery-with-redis@3.0\",\n      \"name\":\"celery-with-redis\",\n      \"purl\":\"pkg:pypi/celery-with-redis@3.0\",\n      \"type\":\"library\",\n      \"version\":\"3.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/redis@3.2.1\",\n      \"name\":\"redis\",\n      \"purl\":\"pkg:pypi/redis@3.2.1\",\n      \"type\":\"library\",\n      \"version\":\"3.2.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/crypto@1.4.1\",\n      \"name\":\"crypto\",\n      \"purl\":\"pkg:pypi/crypto@1.4.1\",\n      \"type\":\"library\",\n      \"version\":\"1.4.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/shellescape@3.4.1\",\n      \"name\":\"shellescape\",\n      \"purl\":\"pkg:pypi/shellescape@3.4.1\",\n      \"type\":\"library\",\n      \"version\":\"3.4.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/naked@0.1.31\",\n      \"name\":\"naked\",\n      \"purl\":\"pkg:pypi/naked@0.1.31\",\n      \"type\":\"library\",\n      \"version\":\"0.1.31\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/pyyaml@5.1\",\n      \"name\":\"pyyaml\",\n      \"purl\":\"pkg:pypi/pyyaml@5.1\",\n      \"type\":\"library\",\n      \"version\":\"5.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/certifi@2019.3.9\",\n      \"name\":\"certifi\",\n      \"purl\":\"pkg:pypi/certifi@2019.3.9\",\n      \"type\":\"library\",\n      \"version\":\"2019.3.9\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/urllib3@1.24.1\",\n      \"name\":\"urllib3\",\n      \"purl\":\"pkg:pypi/urllib3@1.24.1\",\n      \"type\":\"library\",\n      \"version\":\"1.24.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/idna@2.8\",\n      \"name\":\"idna\",\n      \"purl\":\"pkg:pypi/idna@2.8\",\n      \"type\":\"library\",\n      \"version\":\"2.8\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/chardet@3.0.4\",\n      \"name\":\"chardet\",\n      \"purl\":\"pkg:pypi/chardet@3.0.4\",\n      \"type\":\"library\",\n      \"version\":\"3.0.4\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/django@1.8.2\",\n      \"name\":\"django\",\n      \"purl\":\"pkg:pypi/django@1.8.2\",\n      \"type\":\"library\",\n      \"version\":\"1.8.2\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/djangorestframework@3.3.1\",\n      \"name\":\"djangorestframework\",\n      \"purl\":\"pkg:pypi/djangorestframework@3.3.1\",\n      \"type\":\"library\",\n      \"version\":\"3.3.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/ecdsa@0.13\",\n      \"name\":\"ecdsa\",\n      \"purl\":\"pkg:pypi/ecdsa@0.13\",\n      \"type\":\"library\",\n      \"version\":\"0.13\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/fonts@0.0.3\",\n      \"name\":\"fonts\",\n      \"purl\":\"pkg:pypi/fonts@0.0.3\",\n      \"type\":\"library\",\n      \"version\":\"0.0.3\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/jinja2@2.8\",\n      \"name\":\"jinja2\",\n      \"purl\":\"pkg:pypi/jinja2@2.8\",\n      \"type\":\"library\",\n      \"version\":\"2.8\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/markupsafe@1.1.1\",\n      \"name\":\"markupsafe\",\n      \"purl\":\"pkg:pypi/markupsafe@1.1.1\",\n      \"type\":\"library\",\n      \"version\":\"1.1.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/six@1.12.0\",\n      \"name\":\"six\",\n      \"purl\":\"pkg:pypi/six@1.12.0\",\n      \"type\":\"library\",\n      \"version\":\"1.12.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/kazoo@2.6.1\",\n      \"name\":\"kazoo\",\n      \"purl\":\"pkg:pypi/kazoo@2.6.1\",\n      \"type\":\"library\",\n      \"version\":\"2.6.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/lxml@3.4.4\",\n      \"name\":\"lxml\",\n      \"purl\":\"pkg:pypi/lxml@3.4.4\",\n      \"type\":\"library\",\n      \"version\":\"3.4.4\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/paramiko@1.15.1\",\n      \"name\":\"paramiko\",\n      \"purl\":\"pkg:pypi/paramiko@1.15.1\",\n      \"type\":\"library\",\n      \"version\":\"1.15.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/pycrypto@2.6.1\",\n      \"name\":\"pycrypto\",\n      \"purl\":\"pkg:pypi/pycrypto@2.6.1\",\n      \"type\":\"library\",\n      \"version\":\"2.6.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/psycopg2@2.7.7\",\n      \"name\":\"psycopg2\",\n      \"purl\":\"pkg:pypi/psycopg2@2.7.7\",\n      \"type\":\"library\",\n      \"version\":\"2.7.7\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/pyhs2@0.6.0\",\n      \"name\":\"pyhs2\",\n      \"purl\":\"pkg:pypi/pyhs2@0.6.0\",\n      \"type\":\"library\",\n      \"version\":\"0.6.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/sasl@0.2.1\",\n      \"name\":\"sasl\",\n      \"purl\":\"pkg:pypi/sasl@0.2.1\",\n      \"type\":\"library\",\n      \"version\":\"0.2.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/requests@2.9.1\",\n      \"name\":\"requests\",\n      \"purl\":\"pkg:pypi/requests@2.9.1\",\n      \"type\":\"library\",\n      \"version\":\"2.9.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/shortuuid@0.5.0\",\n      \"name\":\"shortuuid\",\n      \"purl\":\"pkg:pypi/shortuuid@0.5.0\",\n      \"type\":\"library\",\n      \"version\":\"0.5.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/sqlalchemy@1.0.1\",\n      \"name\":\"sqlalchemy\",\n      \"purl\":\"pkg:pypi/sqlalchemy@1.0.1\",\n      \"type\":\"library\",\n      \"version\":\"1.0.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/ssh@1.8.0\",\n      \"name\":\"ssh\",\n      \"purl\":\"pkg:pypi/ssh@1.8.0\",\n      \"type\":\"library\",\n      \"version\":\"1.8.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/thrift@0.9.2\",\n      \"name\":\"thrift\",\n      \"purl\":\"pkg:pypi/thrift@0.9.2\",\n      \"type\":\"library\",\n      \"version\":\"0.9.2\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/xlrd@1.2.0\",\n      \"name\":\"xlrd\",\n      \"purl\":\"pkg:pypi/xlrd@1.2.0\",\n      \"type\":\"library\",\n      \"version\":\"1.2.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/xlutils@2.0.0\",\n      \"name\":\"xlutils\",\n      \"purl\":\"pkg:pypi/xlutils@2.0.0\",\n      \"type\":\"library\",\n      \"version\":\"2.0.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/xlwt@1.0.0\",\n      \"name\":\"xlwt\",\n      \"purl\":\"pkg:pypi/xlwt@1.0.0\",\n      \"type\":\"library\",\n      \"version\":\"1.0.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/pillow@6.0.0\",\n      \"name\":\"pillow\",\n      \"purl\":\"pkg:pypi/pillow@6.0.0\",\n      \"type\":\"library\",\n      \"version\":\"6.0.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/elasticsearch@6.4.0\",\n      \"name\":\"elasticsearch\",\n      \"purl\":\"pkg:pypi/elasticsearch@6.4.0\",\n      \"type\":\"library\",\n      \"version\":\"6.4.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/django-redis@4.7.0\",\n      \"name\":\"django-redis\",\n      \"purl\":\"pkg:pypi/django-redis@4.7.0\",\n      \"type\":\"library\",\n      \"version\":\"4.7.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/pip@10.0.1\",\n      \"name\":\"pip\",\n      \"purl\":\"pkg:pypi/pip@10.0.1\",\n      \"type\":\"library\",\n      \"version\":\"10.0.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/wsgiref@0.1.2\",\n      \"name\":\"wsgiref\",\n      \"purl\":\"pkg:pypi/wsgiref@0.1.2\",\n      \"type\":\"library\",\n      \"version\":\"0.1.2\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/python@2.7.10\",\n      \"name\":\"python\",\n      \"purl\":\"pkg:pypi/python@2.7.10\",\n      \"type\":\"library\",\n      \"version\":\"2.7.10\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/webob@1.8.7\",\n      \"name\":\"webob\",\n      \"purl\":\"pkg:pypi/webob@1.8.7\",\n      \"type\":\"library\",\n      \"version\":\"1.8.7\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/kafka@1.3.5\",\n      \"name\":\"kafka\",\n      \"purl\":\"pkg:pypi/kafka@1.3.5\",\n      \"type\":\"library\",\n      \"version\":\"1.3.5\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/uwsgi@2.0.18\",\n      \"name\":\"uwsgi\",\n      \"purl\":\"pkg:pypi/uwsgi@2.0.18\",\n      \"type\":\"library\",\n      \"version\":\"2.0.18\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/docopt@0.6.2\",\n      \"name\":\"docopt\",\n      \"purl\":\"pkg:pypi/docopt@0.6.2\",\n      \"type\":\"library\",\n      \"version\":\"0.6.2\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/mlogging@0.1\",\n      \"name\":\"mlogging\",\n      \"purl\":\"pkg:pypi/mlogging@0.1\",\n      \"type\":\"library\",\n      \"version\":\"0.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/openpyxl@2.6.4\",\n      \"name\":\"openpyxl\",\n      \"purl\":\"pkg:pypi/openpyxl@2.6.4\",\n      \"type\":\"library\",\n      \"version\":\"2.6.4\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/pexpect@2.3\",\n      \"name\":\"pexpect\",\n      \"purl\":\"pkg:pypi/pexpect@2.3\",\n      \"type\":\"library\",\n      \"version\":\"2.3\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/decorator@4.4.2\",\n      \"name\":\"decorator\",\n      \"purl\":\"pkg:pypi/decorator@4.4.2\",\n      \"type\":\"library\",\n      \"version\":\"4.4.2\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/ryze-agent-python@1.1.0\",\n      \"name\":\"ryze-agent-python\",\n      \"purl\":\"pkg:pypi/ryze-agent-python@1.1.0\",\n      \"type\":\"library\",\n      \"version\":\"1.1.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/pipreqs@0.4.10\",\n      \"name\":\"pipreqs\",\n      \"purl\":\"pkg:pypi/pipreqs@0.4.10\",\n      \"type\":\"library\",\n      \"version\":\"0.4.10\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/typing@3.7.4.3\",\n      \"name\":\"typing\",\n      \"purl\":\"pkg:pypi/typing@3.7.4.3\",\n      \"type\":\"library\",\n      \"version\":\"3.7.4.3\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/wheel@0.37.1\",\n      \"name\":\"wheel\",\n      \"purl\":\"pkg:pypi/wheel@0.37.1\",\n      \"type\":\"library\",\n      \"version\":\"0.37.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/pyprotect@1.0\",\n      \"name\":\"pyprotect\",\n      \"purl\":\"pkg:pypi/pyprotect@1.0\",\n      \"type\":\"library\",\n      \"version\":\"1.0\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/jdcal@1.4.1\",\n      \"name\":\"jdcal\",\n      \"purl\":\"pkg:pypi/jdcal@1.4.1\",\n      \"type\":\"library\",\n      \"version\":\"1.4.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/yarg@0.1.9\",\n      \"name\":\"yarg\",\n      \"purl\":\"pkg:pypi/yarg@0.1.9\",\n      \"type\":\"library\",\n      \"version\":\"0.1.9\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/et-xmlfile@1.0.1\",\n      \"name\":\"et-xmlfile\",\n      \"purl\":\"pkg:pypi/et-xmlfile@1.0.1\",\n      \"type\":\"library\",\n      \"version\":\"1.0.1\"\n    },\n    {\n      \"bom-ref\":\"pkg:pypi/pil@1.1.7\",\n      \"name\":\"pil\",\n      \"purl\":\"pkg:pypi/pil@1.1.7\",\n      \"type\":\"library\",\n      \"version\":\"1.1.7\"\n    }\n  ],\n  \"metadata\":{\n    \"timestamp\":\"2022-08-12T08:03:30.459054+00:00\",\n    \"tools\":[\n      {\n        \"name\":\"SDA\",\n        \"vendor\":\"****\",\n        \"version\":\"v7.0\"\n      }\n    ]\n  },\n  \"serialNumber\":\"urn:uuid:bf6ceb1f-3cfc-4475-be23-656ac8b34002\",\n  \"specVersion\":\"1.4\",\n  \"version\":1,\n  \"vulnerabilities\":[ ]\n}"
	Rpc(py_sbom)
}

// 调用sca分析引擎
func Rpc(sbom string) bool {
	var recvSize = 1024 * 1024 * 1024 * 1024 * 1024
	host := "127.0.0.1"
	conn, err := grpc.Dial(host+":8080", grpc.WithInsecure(), grpc.WithDefaultCallOptions(grpc.MaxCallRecvMsgSize(recvSize)))
	if err != nil {
		fmt.Println(err.Error())
		return false
	}
	// 创建Themis服务的客户端
	t := ryzesca.NewRyzescaClient(conn)

	end, err := t.RunRyzescaCycloneDX(context.Background(), &ryzesca.RyzescaParams{
		IdentifierPackage: true,
		FindingPackageVul: true,
		SimplePackageVul:  false,
		FindingSummary:    false,
		OnlyFindings:      false,
		OnlyJsonSummary:   false,
		CyclonedxJsonpath: "",
		CyclonedxJson:     sbom})
	if err != nil {
		fmt.Println("********************", err.Error())
		return false
	}
	// 将结果写入文件
	//create, _ := os.Create("res.json")
	//marshal, _ := json.Marshal(end.Files)
	//_, _ = create.Write(marshal)
	//_ = create.Close()
	fmt.Println(end.Files)
	return true
}
